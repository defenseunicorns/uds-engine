includes:
  - setup: ./setup.yaml

tasks:
  - name: e2e
    description: "run end-to-end tests (assumes api server is running on port 8080)"
    actions:
      - task: setup:build-ui
      - cmd: npm run test:install # install playwright
        dir: ui
      - task: setup:build-api
      - cmd: k3d cluster create --image="rancher/k3s:v1.28.4-k3s2"
      - task: deploy-load
      - cmd: npm run test:integration
        dir: ui
  - name: go
    description: "run api server unit tests"
    actions:
      - cmd: go test -failfast -v -timeout 30m ./...

  - name: ui-unit
    description: "run frontend unit tests"
    actions:
      - cmd: npm ci && npm run test:unit
        dir: ui

  - name: unit
    description: "run all unit tests (backend and frontend)"
    actions:
      - task: setup:build-ui
        description: "build ui since embedded in main.go"
      - task: go
      - task: ui-unit

  - name: deploy-load
    description: "deploy some Zarf packages to test against"
    actions:
      - task: deploy-core-pepr
      - cmd: uds zarf p d oci://ghcr.io/defenseunicorns/packages/init:v0.36.1 --confirm
      - cmd: uds zarf p d oci://ghcr.io/defenseunicorns/uds-cli/podinfo:0.0.2 --confirm

  - name: deploy-core-pepr
    description: only run engine e2e tests
    actions:
      - cmd: rm -fr tmp && git clone --depth=1 https://github.com/defenseunicorns/uds-core.git tmp/uds-core
        description: clone UDS Core
      - cmd: cd tmp/uds-core && npm i && npx pepr deploy --confirm
        description: cd into the tmp/uds-core directory and deploy UDS Core's Pepr module
